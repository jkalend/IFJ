# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

orbs:
  codecov: codecov/codecov@3.2.3

parameters:
  codecov_token:
    type: string
    default: "08f6afd7-6b12-41b3-8922-a06b44826d96"

commands:
  prepare_env:
    steps:
      - run:
          name: "Create bin directory"
          command: "mkdir -p bin"
      - run:
          name: "Install clang"
          command: |
            sudo apt-get update
            sudo apt-get install -y clang
      - run:
          name: "Install cmake"
          command: |
            sudo apt-get update
            sudo apt-get install -y cmake
#      - run:
#          name: "Update Cmake"
#          command: |
#            curl -OL https://github.com/Kitware/CMake/releases/download/v3.24.2/cmake-3.24.2.tar.gz
#            tar -xzf cmake-3.24.2.tar.gz
#            cd cmake-3.24.2
#            cmake .
#            make
#            sudo make install
#          when: never

  coverage:
    steps:
      - codecov/upload:
          xtra_args: '--gcov'


# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/2.0/configuration-reference/#jobs
jobs:
  stack_test_cmake:
    docker:
      - image: cimg/base:stable
    environment:
      CODECOV_TOKEN: << pipeline.parameters.codecov_token >>
    steps:
      - checkout
      - prepare_env
      - run:
          name: "Compile"
          command: "cmake -B build -S . && cmake --build build"
      - run:
          name: "Run tests"
          command: "ctest -C Debug -T test --force-new-ctest-process"
      - run:
          name: "Get Coverage"
          command: "gcov stack.c stack.h stack_test.c"
      - coverage

# Invoke jobs via workflows
# See: https://circleci.com/docs/2.0/configuration-reference/#workflows
workflows:
  say-hello-workflow:
    jobs:
      - stack_test_cmake